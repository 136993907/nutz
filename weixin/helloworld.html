<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8"/>
<title>微信集成 快速入门</title><link href="../zdoc.css" rel="stylesheet" type="text/css"/>
</head>
<body><a name="top"></a>
<div class="zdoc_header">微信集成 快速入门</div>
<div class="zdoc_author"><em>By:</em><b>wendal</b><a href="mailto:wendal1985@gmail.com">&lt;wendal1985@gmail.com&gt;</a></div>
<div class="zdoc_body">
<ul class="zdoc_index_table">
<li>
<div><span class="num">1</span><a href="#Nutz_为_微信准备了什么?">Nutz 为 微信准备了什么?</a></div>
</li>
<li>
<div><span class="num">2</span><a href="#首先,你需要一个公众号">首先,你需要一个公众号</a></div>
</li>
<li>
<div><span class="num">3</span><a href="#然后,你需要一个外网地址">然后,你需要一个外网地址</a></div>
</li>
<li>
<div><span class="num">4</span><a href="#添加依赖">添加依赖</a></div>
</li>
<li>
<div><span class="num">5</span><a href="#添加第一个微信Module">添加第一个微信Module</a></div>
</li>
<li>
<div><span class="num">6</span><a href="#通过外网访问msgin入口方法">通过外网访问msgin入口方法</a></div>
</li>
<li>
<div><span class="num">7</span><a href="#配置测试号的URL和token">配置测试号的URL和token</a></div>
</li>
<li>
<div><span class="num">8</span><a href="#测试被动消息响应">测试被动消息响应</a></div>
</li>
</ul>
<div class="hr"><b></b></div>
<h1><a name="Nutz_为_微信准备了什么?"></a>Nutz 为 微信准备了什么?</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>nutzwx是nutz集成微信所做的jar包,起于2014年. 那时候还只有公众平台,没有微信支付,没有商户平台,没有开放平台...</p>
<p>算了, 你们应该没兴趣看nutzwx项目的发展史的,我删掉吧.</p>
<p>往下看如何集成吧.</p>
<div class="hr"><b></b></div>
<h1><a name="首先,你需要一个公众号"></a>首先,你需要一个公众号</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>是的,我说的是测试号,不是正式的公众号.</p>
<p>访问这个地址 <a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login">微信公众平台接口测试帐号申请</a></p>
<p><img src="sanbox_homepage.png"/></p>
<p>注册/登录后, 可以看到:</p>
<p><img src="sanbox_info.png"/></p>
<p>其中,appid和appsecret都会显示,但接口配置信息是需要手工填的, 里面有URL和token.</p>
<p>而URL必须填一个外网地址,而且不能带端口号!!! 很多人会说: 靠,怎么搞!!!? 恩,继续往下看, 先不要关掉这个页面哦.</p>
<div class="hr"><b></b></div>
<h1><a name="然后,你需要一个外网地址"></a>然后,你需要一个外网地址</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>也许你登录过nutzcn或者听说过,或者不知道它是什么鬼东西,没关系, 你现在要访问它</p>
<p>地址: <a href="https://nutz.cn/yvr/list">NutzCN社区</a> 请使用github登录, 若没有github账号或者翻墙困难,可以使用QQ或微信登录.</p>
<p>登录完成后, 访问 <a href="https://nutz.cn/yvr/links/ngrok.html">Ngrok内网穿透福利</a></p>
<p>点击下载配置文件和客户端,按说明启动ngrok,即可获取外网地址.</p>
<p>我们还提供Java版的Ngrok客户端哦 请访问帖子 <a href="https://nutz.cn/yvr/t/2gdt1tfu84jsjq29ltvu45jvr1">Ngrok新版客户端</a></p>
<p>PS: Ngrok是什么鬼东西? 内网穿透, 就是把你本地某个http服务,通过隧道协议, 映射到外网.</p>
<p>若有兴趣了解nutz提供的ngrok实现, 请访问<a href="https://github.com/nutzam/nutzmore/tree/master/nutz-plugins-ngrok">NutzMore上的Ngrok插件</a></p>
<div class="hr"><b></b></div>
<h1><a name="添加依赖"></a>添加依赖</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>现在,你应该有一个微信测试号和一个外网地址了,接下来,我们需要添加nutzwx了</p>
<p>若使用maven,添加如下配置. 如果不知道怎么配置快照库,请查阅 <a href="../baisc/maven.man">Maven基本配置</a></p>
<pre>&lt;dependency&gt;
	&lt;groupId&gt;org.nutz&lt;/groupId&gt;
	&lt;artifactId&gt;nutzwx&lt;/artifactId&gt;
	&lt;version&gt;1.r.62-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</pre>
<p>非maven用户,也可以在快照中找到 <a href="https://jfrog.nutz.cn/artifactory/snapshots/org/nutz/nutzwx/">Nutzwx最新快照</a> 的jar文件,请使用日期最新的哦</p>
<div class="hr"><b></b></div>
<h1><a name="添加第一个微信Module"></a>添加第一个微信Module</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<pre>@IocBean
@At("/weixin")
public class WeixinModule { <span class="zdoc_code_cmt">// 并不要求你继承任何东西
</span>
    /*
    wxHandler是被动请求的主要处理类, 里面写的1234567890就是"接口配置信息"里面提到的"token",
    */
    protected WxHandler wxHandler = new BasicWxHandler("1234567890");

    @At <span class="zdoc_code_cmt">// 拼起来的全路径就是 /weixin/msgin
</span>    public View msgin(HttpServletRequest req) throws IOException {
        return Wxs.handle(wxHandler, req, "default"); <span class="zdoc_code_cmt">// 最后面的default,可以不写,只是个标识符.
</span>    }
}
</pre>
<p>现在,启动你的web项目,访问 http://127.0.0.1:8080/$项目名称/weixin/msgin</p>
<p>应该会出502之类的提示,那就是对的. 但如果出404,那么,就需要检查启动日志(例如方法名写错导致映射路径错了)</p>
<pre>20:51:39.955 WARN  (Wxs.java:213) check - bad check : signature=null,timestamp=null,nonce=null
</pre>
<div class="hr"><b></b></div>
<h1><a name="通过外网访问msgin入口方法"></a>通过外网访问msgin入口方法</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>现在,确保ngrok已经启动, 访问地址 http://$用户名.ngrok.wendal.cn/$项目名称/weixin/msgin</p>
<p>其中,用户名在ngrok的界面可以看到,通常就是你的nutzcn用户名(去掉下划线)</p>
<p>看清楚地址,不要加端口号哦. 如无意外, 跟你本地访问的效果一样, 后台日志也是出bad check</p>
<div class="hr"><b></b></div>
<h1><a name="配置测试号的URL和token"></a>配置测试号的URL和token</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>打开测试号管理页面, 填入上一步测试过的外网地址及WeixinModule的token值,按确认</p>
<p>请观察后台日志的变化,若出现下面的日志就代表成功了.</p>
<pre>21:07:25.161 INFO  (Wxs.java:636) handle - GET? return echostr=5786772326126714267
</pre>
<p>若出现bad check, 检查token的值哦. 页面上的值需要与WeixinModule的值一致才能成功.</p>
<div class="hr"><b></b></div>
<h1><a name="测试被动消息响应"></a>测试被动消息响应</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>依然是测试号管理页面, 打开你的微信,关注自己.</p>
<p>发送文本信息(2个字): 帮助</p>
<p>公众号将返回如下信息</p>
<pre>支持的命令有: 你好 版本 帮助 appid 测试文本 测试新闻 回显
</pre>
<p><img src="weixin_warnup.png"/></p>
</div>
<div class="zdoc_footer"><em>By:</em><b>wendal</b><a href="mailto:wendal1985@gmail.com">&lt;wendal1985@gmail.com&gt;</a></div>
</body>
</html>