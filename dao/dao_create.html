<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8"/>
<title>自动建表</title><link href="../zdoc.css" rel="stylesheet" type="text/css"/>
</head>
<body><a name="top"></a>
<div class="zdoc_header">自动建表</div>
<div class="zdoc_author"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a></div>
<div class="zdoc_body">
<ul class="zdoc_index_table">
<li>
<div><span class="num">1</span><a href="#背景">背景</a></div>
</li>
<li>
<div><span class="num">2</span><a href="#基本用法">基本用法</a></div>
</li>
<li>
<div><span class="num">3</span><a href="#批量建表">批量建表</a></div>
</li>
<li>
<div><span class="num">4</span><a href="#表结构迁移">表结构迁移</a></div>
</li>
<li>
<div><span class="num">5</span><a href="#自动建表的字段配置">自动建表的字段配置</a></div>
</li>
<li>
<div><span class="num">6</span><a href="#自动建表的索引配置">自动建表的索引配置</a></div>
</li>
</ul>
<div class="hr"><b></b></div>
<h1><a name="背景"></a>背景</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>部署到生产环境的时候需要导入SQL文件,是否觉得很繁琐? 而且还得为不同的数据库准备不同的SQL脚本? 太麻烦了是不是.</p>
<p>如果能自动建表,自动迁移表结构,然后导入初始化数据,是不是部署过程就非常容易了呢?? 想想就有点小激动.</p>
<div class="hr"><b></b></div>
<h1><a name="基本用法"></a>基本用法</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>首先,你得有一个dao实例, 还有一个Pojo类.</p>
<pre>dao.create(User.class, false); <span class="zdoc_code_cmt">// 第一个参数是类, 第二个参数代表是否强制删除重建,通常是false
</span></pre>
<p>然后它就能很华丽得输出并执行create table语句了.</p>
<pre>CREATE TABLE t_user(
id INT(32),
name VARCHAR(128) UNIQUE NOT NULL,
passwd VARCHAR(128),
salt VARCHAR(128),
locked BOOLEAN,
ct DATETIME,
ut DATETIME,
PRIMARY KEY (id)
) ENGINE=InnoDB CHARSET=utf8
</pre>
<div class="hr"><b></b></div>
<h1><a name="批量建表"></a>批量建表</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>要是有几十个Pojo,那岂不是要累死? Nutz当然不会让你太累的.</p>
<p>通常,pojo都集中存在的某个package下,所以我们只需要告诉Daos.createTableInPackage方法所在的位置就行</p>
<pre>Daos.createTablesInPackage(dao, "net.wendal.nutzbook.bean", false);
</pre>
<p>然后,它就会扫描该package下,所以带@Table注解的Pojo类,逐一执行dao.create</p>
<div class="hr"><b></b></div>
<h1><a name="表结构迁移"></a>表结构迁移</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>老板说要每个用户新增加个phone字段,咋搞? 自定义SQL执行一条ALTER吗? 不不不,自动迁移一下表结构就好了.</p>
<pre>Daos.migration(User.class, true, false, false);
</pre>
<p>第一个参数是类,第二个参数是否新增字段,第三个参数是否删除字段(通常为false),第4个参数是否检查索引(通常为false).</p>
<p>额,那很多很多pojo呢? 也能批量迁移吗? 可以的</p>
<pre>Daos.migration(dao, "net.wendal.nutzbook.bean", true, false, false);
</pre>
<div class="hr"><b></b></div>
<h1><a name="自动建表的字段配置"></a>自动建表的字段配置</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>建表时的详细配置,大部分通过@ColDefine实现</p>
<p>定义字符串长度,例如1024,你懂的</p>
<pre>@ColDefine(width=1024)
private String name;
</pre>
<p>定义浮点数精度</p>
<pre>@ColDefine(width=10,precision=2, type=ColType.FLOAT) <span class="zdoc_code_cmt">// 对数据库来说没有float和double的区别
</span>private double price;
</pre>
<p>不允许为null</p>
<pre>@ColDefine(notNull=true, width=128)
private String nickname;
</pre>
<p>自定义类型,终极大招,没法自适应数据库了.</p>
<pre>@ColDefine(customType="LargeBlob", type=ColType.BLOB)
private Blob blob;
</pre>
<div class="hr"><b></b></div>
<h1><a name="自动建表的索引配置"></a>自动建表的索引配置</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>除了为@Id/@Name/@Pk建立自动索引之外, 通过@TableIndexes注解可以配置更多自定义索引.</p>
<p>例如为name和age建立联合索引</p>
<pre>@Table("t_user")
@TableIndexes({@Index(name="name_age", fields={"name", "age"}, unique=false)})
</pre>
<p>自1.r.63起，索引的名称可以自动帮你生成，上面的例子，如果name不填的话，默认"IX_TableName_name_age"，及"前缀_表名_字段名"其中，唯一索引前缀为"UX_"，非唯一索引前缀为"IX_"</p>
</div>
<div class="zdoc_footer"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a></div>
</body>
</html>