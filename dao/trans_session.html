<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head><meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8"/>
<title>NutTxDao简介</title><link href="../zdoc.css" rel="stylesheet" type="text/css"/>
</head>
<body><a name="top"></a>
<div class="zdoc_header">NutTxDao简介</div>
<div class="zdoc_author"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a></div>
<div class="zdoc_body">
<ul class="zdoc_index_table">
<li>
<div><span class="num">1</span><a href="#NutTxDao的由来">NutTxDao的由来</a></div>
</li>
<li>
<div><span class="num">2</span><a href="#用法">用法</a></div>
</li>
<li>
<div><span class="num">3</span><a href="#多线程环境">多线程环境</a></div>
</li>
<li>
<div><span class="num">4</span><a href="#交叉事务">交叉事务</a></div>
</li>
<li>
<div><span class="num">5</span><a href="#调试开关">调试开关</a></div>
</li>
</ul>
<div class="hr"><b></b></div>
<h1><a name="NutTxDao的由来"></a>NutTxDao的由来</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>先看看Trans的优缺点</p>
<ul type="disc">
<li>自动事务管理, 一个内部类完全隔离事务实现, 能有效确保事务的完整性,而且很直观.</li>
<li>不支持嵌套事务</li>
<li>手动控制事务比较麻烦</li>
</ul>
<pre>Trans.exec( () -&gt; {
	dao.update(user);
	dao.update(role);
});
</pre>
<p>NutTxDao试图解决:</p>
<ul type="disc">
<li>嵌套事务及手动控制事务,以增强事务的可控性</li>
<li>借助JDK7+的try-with-resource语法,协助用户确保事务的完整性</li>
</ul>
<pre>    try (NutTxDao tx = new NutTxDao(dao);) {
        tx.beginRC();
        tx.update(user);
        tx.update(role);
        tx.commit();
    } catch (Throwable e) {
    	tx.rollback();
    	log.debug("tx fail", e);
    } finally {
    	tx.close();
    }
</pre>
<div class="hr"><b></b></div>
<h1><a name="用法"></a>用法</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>NutTxDao 是NutDao的子类,通过复制NutDao的内部状态,并设置DaoRunner实例, 改变原有的事务控制逻辑</p>
<p>一般写法</p>
<pre>	<span class="zdoc_code_cmt">// 通过NutDao实例构建一下NutTxDao
</span>	NutTxDao tx = new NutTxDao(dao);
    try {
    	<span class="zdoc_code_cmt">// 开启事务, tx.beginRC()开启事务级别为Connection.READ_COMMITTED. 是 tx.begin(Connection.READ_COMMITTED); 的缩写.
</span>        tx.beginRC(); 
        
        tx.update(user);
        tx.update(role);
        
        <span class="zdoc_code_cmt">// 提交事务
</span>        tx.commit();
    } catch (Throwable e) {
    	<span class="zdoc_code_cmt">// 回滚事务
</span>    	tx.rollback();
    	log.debug("tx fail", e);
    } finally {
    	<span class="zdoc_code_cmt">// 关闭事务
</span>    	tx.close();
    }
</pre>
<p>结合JDK7+语法</p>
<pre>	<span class="zdoc_code_cmt">// 通过NutDao实例构建一下NutTxDao
</span>    try (NutTxDao tx = new NutTxDao(dao);) {
    	<span class="zdoc_code_cmt">// 开启事务, tx.beginRC()开启事务级别为Connection.READ_COMMITTED. 是 tx.begin(Connection.READ_COMMITTED); 的缩写.
</span>        tx.beginRC(); 
        
        tx.update(user);
        tx.update(role);
        
        <span class="zdoc_code_cmt">// 提交事务
</span>        tx.commit();
    } catch (Throwable e) {
    	<span class="zdoc_code_cmt">// 回滚事务
</span>    	tx.rollback();
    	log.debug("tx fail", e);
    }
</pre>
<div class="hr"><b></b></div>
<h1><a name="多线程环境"></a>多线程环境</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>NutTxDao的beginX/commit/rollback/close*不是*线程安全的.</p>
<p>NutTxDao应该以局部变量的形式出现在代码中,而不应该是实例属性或静态属性.</p>
<p>创建NutTxDao自身的成本很低,相对于数据库事务来说微乎其微.</p>
<div class="hr"><b></b></div>
<h1><a name="交叉事务"></a>交叉事务</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>NutTxDao的事务仅依赖于实例本身,与Trans无关,也与其他NutTxDao实例无关.</p>
<p>所以, 你可以同时开始多个事务, 然后按需要调用commit或rollback</p>
<pre>NutTxDao tx1 = new NutTxDao(dao);
NutTxDao tx2 = new NutTxDao(dao);
NutTxDao tx3 = new NutTxDao(dao);
try {
	tx1.beiginRC();
	tx2.beiginRC();
	
	<span class="zdoc_code_cmt">// 中间嵌套一个独立的事务3
</span>	tx3.beiginRC();
	tx3.commit();
	
	tx1.commit();
	tx2.commit();
} catch (Throwable e) {
	tx1.rollback();
	tx2.rollback();
	tx3.rollback();
}
</pre>
<div class="hr"><b></b></div>
<h1><a name="调试开关"></a>调试开关</h1>
<div style="float:right;"><a href="#top">Top</a></div>
<p>若对一个NutTxDao的事务行为有疑惑,可以开启其debug开关</p>
<pre>NutTxDao tx1 = new NutTxDao(dao).setDebug(true);
</pre>
</div>
<div class="zdoc_footer"><em>By:</em><b>zozoh</b><a href="mailto:zozohtnt@gmail.com">&lt;zozohtnt@gmail.com&gt;</a></div>
</body>
</html>